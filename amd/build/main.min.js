define(["jquery","core/modal_factory"],function(a,b){return{xhrs:{},item_as_modal:function(c){console.log("mod_confman/main -> item_as_modal(sender)",c);var d=a(c).closest("tr");a.ajax({url:a(c).attr("href")+"&embedded=1&noheader=1",data:{},success:function(a){b.create({type:b.types.OK,title:d.find(".title").html(),body:a}).then(function(a){a.show()})},dataType:"html"})},item_as_modal_prepare:function(b){console.log("mod_confman/main -> item_as_modal_prepare(uniqid)",b),a("#"+b+"-items a.preview").attr("onclick","var a = this; require(['mod_confman/main'], function(MAIN) { MAIN.item_as_modal(a); }); return false;")},item_file_mail:function(b,c,d,e){console.log("mod_confman/main -> item_file_mail(wwwroot, id, token, type)",b,c,d,e),a.ajax({url:b+"/mod/confman/ajax.php",data:{act:"file_mail",id:c,token:d,type:e},success:function(a){console.log(" => Response",a)},dataType:"html"})},item_remove_file:function(b){var c=this,d=a(b).closest("div"),e=a(b).closest("form"),f=a(d).attr("data-wwwroot"),g=a(d).find(".filename").attr("data-filename"),h=a(e).find('input[name="id"]').val(),i=a(e).find('input[name="token"]').val();console.log(f+"/mod/confman/ajax.php?act=file_delete&id="+h+"&token="+i+"&filename="+g),a.ajax({url:f+"/mod/confman/ajax.php",data:{act:"file_delete",id:h,token:i,filename:g},success:function(b){console.log(" => Response",b);try{var e=JSON.parse(b);"undefined"!=typeof e.status&&"ok"==e.status?(console.log(" => File removed"),a(d).remove(),c.item_file_mail(f,h,i,"file_delete")):alert("Error removing file")}catch(g){console.log("Could not analyze result",g)}},dataType:"html"})},selectAllNone:function(b){var c=a("#"+b+"-items").attr("data-selectall");"1"==c?(a("#"+b+"-items").attr("data-selectall",""),a("#"+b+"-items .export>input").prop("checked",!1)):(a("#"+b+"-items").attr("data-selectall","1"),a("#"+b+"-items .export>input").prop("checked",!0))},selectApproved:function(b){a("#"+b+"-items .approved .export>input").prop("checked",!0)},set_approved:function(b,c,d,e){console.log("mod_confman/main -> set_approved(wwwroot, id, token, a)",b,c,d,e);var f=a(e).closest("tr"),g=a(f).hasClass("approved");a.ajax({url:b+"/mod/confman/ajax.php",data:{act:"set_approved",id:c,token:d,setto:g?0:1},success:function(c){console.log(" => Response",c);try{var d=JSON.parse(c);"undefined"!=typeof d.status&&"ok"==d.status&&(console.log(" => Success"),"undefined"!=typeof d.setto&&d.setto?(a(f).addClass("approved"),a(f).find(".approve img").attr("src",b+"/pix/i/completion-auto-pass.svg")):(a(f).removeClass("approved"),a(f).find(".approve img").attr("src",b+"/pix/i/completion-auto-n.svg")))}catch(e){console.log("Could not analyze result",e)}},dataType:"html"})},upload_file:function(b,c,d,e,f){console.log("mod_confman/main -> upload_file(inp)",b);for(var g=this,h=0;h<b.files.length;h++){var i=b.files[h];g.upload_file_item(d,c,e,f,i)}a(b).val("")},upload_file_domo:function(b,c,d){var e=a("#mod_confman_form-"+b+' div[data-filename="'+d+'"]');if(0==e.length){var e=a('<div class="file_item" style="width: 100%;" data-filename="'+d+'">').append([a('<span class="progress" style="width: 20px; display: inline-block;">').append([a('<span style="display: inline-block; background-color: lightblue;">').html("&nbsp;")]),a('<span class="remove" style="width: 20px; display: none;"><a href="#"><img src="/pix/t/delete.svg" alt="delete" /></a></span>'),a('<span class="filename" style="width: calc(100% - 55px); display: inline-block; padding-left: 10px; overflow: hidden;">').attr("data-filename",d).html(d)]);a("#mod_confman_form-"+b).append(e)}return a(e).attr("data-wwwroot",c),e},upload_file_item:function(b,c,d,e,f){var g=this,h=new FileReader;h.addEventListener("load",function(){var i=new FormData;i.append("act","file_append"),i.append("id",d),i.append("token",e),i.append("filename",f.name),i.append("file",h.result),"undefined"!=typeof g.xhrs[f.name]&&g.xhrs[f.name].abort();var j=g.upload_file_domo(b,c,f.name);g.upload_file_prepare_uploading(j);var k=new XMLHttpRequest;k.upload.addEventListener("loadstart",function(a){console.log("mod_confman/main -> upload_file_item_event_start(event)",a)},!1),k.upload.addEventListener("progress",function(b){console.log("mod_confman/main -> upload_file_item_event_progress(event)",b);var c=Math.floor(b.loaded/(b.total/100));console.log(" => Progress is now ",c,"%"),a(j).find(".progress>span").css("width",c+"%")},!1),k.upload.addEventListener("load",function(a){console.log("mod_confman/main -> upload_file_item_event_load(event)",a)},!1),k.addEventListener("readystatechange",function(b){if(console.log("mod_confman/main -> upload_file_item_event_readystatechange(event)",b),4==b.target.readyState){var f=a(j).find(".filename").attr("data-filename");switch("undefined"!=typeof g.xhrs[f]&&delete g.xhrs[f],b.target.status){case 200:try{var h=JSON.parse(k.responseText);"undefined"!=typeof h.url&&(a(j).find(".filename").attr("data-url",h.url),g.upload_file_prepare_uploaded(j),g.item_file_mail(c,d,e,"file_append"))}catch(i){console.log(" => Invalid result was",k.responseText)}break;case 404:alert("HTTP-Error 404");break;default:alert("HTTP-Status "+b.target.status)}}},!1),k.open("POST",c+"/mod/confman/ajax.php",!0),g.xhrs[j.find(".filename").html()]=k,k.send(i)},!1),h.readAsDataURL(f)},upload_file_prepare:function(b,c,d){console.log("mod_confman/main -> upload_file_prepare(uniqid, wwwroot, files)",b,c,d),d=JSON.parse(d);for(var e=0;e<d.length;e++){var f=this.upload_file_domo(b,c,d[e].filename);a(f).find(".filename").attr("data-url",d[e].url),this.upload_file_prepare_uploaded(f)}},upload_file_prepare_uploaded:function(b){a(b).find(".remove").css("display","inline-block"),a(b).find(".remove>a").attr("onclick",'var a = this; require(["mod_confman/main"], function(MAIN) { MAIN.item_remove_file(a); }); return false;'),a(b).find(".progress").css("display","none");var c=a(b).find(".filename").attr("data-filename"),d=a(b).find(".filename").attr("data-url");a(b).find(".filename").html('<a href="'+d+'" target="_blank">'+c+"</a>")},upload_file_prepare_uploading:function(b){a(b).find(".filename").html(a(b).find(".filename").attr("data-filename")),a(b).find(".progress").css("display","inline-block").children().css("width","0%"),a(b).find(".remove").css("display","none")}}});